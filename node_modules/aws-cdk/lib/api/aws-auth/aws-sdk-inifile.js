"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PatchedSharedIniFileCredentials = void 0;
const AWS = require("aws-sdk");
/**
 * Hack-fix
 *
 * There are a number of issues in the upstream version of SharedIniFileCredentials
 * that need fixing:
 *
 * 1. The upstream aws-sdk does not support the 'credential_source' option. Meaning credentials
 *    for assume-role cannot be fetched using EC2/ESC metadata.
 *
 * 2. The upstream aws-sdk does not support SSO profiles as the source of RoleProfiles,
 *    because it will always use the `SharedIniFileCredentials` provider to load
 *    source credentials, but in order to support SSO profiles you must use a
 *    separate class (`SsoCredentials).
 */
class PatchedSharedIniFileCredentials extends AWS.SharedIniFileCredentials {
    loadRoleProfile(creds, roleProfile, callback) {
        // Need to duplicate the whole implementation here -- the function is long and has been written in
        // such a way that there are no small monkey patches possible.
        if (this.disableAssumeRole) {
            throw AWS.util.error(new Error('Role assumption profiles are disabled. ' +
                'Failed to load profile ' + this.profile +
                ' from ' + creds.filename), { code: 'SharedIniFileCredentialsProviderFailure' });
        }
        var self = this;
        var roleArn = roleProfile.role_arn;
        var roleSessionName = roleProfile.role_session_name;
        var externalId = roleProfile.external_id;
        var mfaSerial = roleProfile.mfa_serial;
        var sourceProfile = roleProfile.source_profile;
        var credentialSource = roleProfile.credential_source;
        if (!!sourceProfile === !!credentialSource) {
            throw AWS.util.error(new Error(`When using 'role_arn' in profile ('${this.profile}'), you must also configure exactly one of 'source_profile' or 'credential_source'`), { code: 'SharedIniFileCredentialsProviderFailure' });
        }
        // Confirmed this against AWS CLI behavior -- the region must be in the assumED profile,
        // otherwise `us-east-1`. From the upstream comment in `aws-sdk-js`:
        // -------- comment from aws-sdk-js -------------------
        // Experimentation shows that the AWS CLI (tested at version 1.18.136)
        // ignores the following potential sources of a region for the purposes of
        // this AssumeRole call:
        //
        // - The [default] profile
        // - The AWS_REGION environment variable
        //
        // Ignoring the [default] profile for the purposes of AssumeRole is arguably
        // a bug in the CLI since it does use the [default] region for service
        // calls... but right now we're matching behavior of the other tool.
        // -------------------------------------------------
        const region = roleProfile?.region ?? 'us-east-1';
        const stsCreds = sourceProfile ? this.sourceProfileCredentials(sourceProfile, creds) : this.credentialSourceCredentials(credentialSource);
        this.roleArn = roleArn;
        var sts = new AWS.STS({
            credentials: stsCreds,
            region,
            httpOptions: this.httpOptions,
        });
        var roleParams = {
            RoleArn: roleArn,
            RoleSessionName: roleSessionName || 'aws-sdk-js-' + Date.now(),
        };
        if (externalId) {
            roleParams.ExternalId = externalId;
        }
        if (mfaSerial && self.tokenCodeFn) {
            roleParams.SerialNumber = mfaSerial;
            self.tokenCodeFn(mfaSerial, function (err, token) {
                if (err) {
                    var message;
                    if (err instanceof Error) {
                        message = err.message;
                    }
                    else {
                        message = err;
                    }
                    callback(AWS.util.error(new Error('Error fetching MFA token: ' + message), { code: 'SharedIniFileCredentialsProviderFailure' }));
                    return;
                }
                roleParams.TokenCode = token;
                sts.assumeRole(roleParams, callback);
            });
            return;
        }
        sts.assumeRole(roleParams, callback);
    }
    sourceProfileCredentials(sourceProfile, profiles) {
        var sourceProfileExistanceTest = profiles[sourceProfile];
        if (typeof sourceProfileExistanceTest !== 'object') {
            throw AWS.util.error(new Error('source_profile ' + sourceProfile + ' using profile '
                + this.profile + ' does not exist'), { code: 'SharedIniFileCredentialsProviderFailure' });
        }
        // We need to do a manual check here if the source profile (providing the
        // credentials for the AssumeRole) is an SSO profile. That's because
        // `SharedIniFileCredentials` itself doesn't support providing credentials from
        // arbitrary profiles, only for StaticCredentials and AssumeRole type
        // profiles; if it's an SSO profile you need to instantiate a special
        // Credential Provider for that.
        //
        // ---
        //
        // An SSO profile can be configured in 2 ways (put all the info in the profile
        // section, or put half of it in an `[sso-session]` block), but in both cases
        // the primary profile block must have the `sso_account_id` key
        if (sourceProfileExistanceTest.sso_account_id) {
            return new AWS.SsoCredentials({ profile: sourceProfile });
        }
        return new PatchedSharedIniFileCredentials(AWS.util.merge(this.options || {}, {
            profile: sourceProfile,
            preferStaticCredentials: true,
        }));
    }
    // the aws-sdk for js does not support 'credential_source' (https://github.com/aws/aws-sdk-js/issues/1916)
    // so unfortunately we need to implement this ourselves.
    credentialSourceCredentials(sourceCredential) {
        // see https://docs.aws.amazon.com/credref/latest/refdocs/setting-global-credential_source.html
        switch (sourceCredential) {
            case 'Environment': {
                return new AWS.EnvironmentCredentials('AWS');
            }
            case 'Ec2InstanceMetadata': {
                return new AWS.EC2MetadataCredentials();
            }
            case 'EcsContainer': {
                return new AWS.ECSCredentials();
            }
            default: {
                throw new Error(`credential_source ${sourceCredential} in profile ${this.profile} is unsupported. choose one of [Environment, Ec2InstanceMetadata, EcsContainer]`);
            }
        }
    }
}
exports.PatchedSharedIniFileCredentials = PatchedSharedIniFileCredentials;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXdzLXNkay1pbmlmaWxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXdzLXNkay1pbmlmaWxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLCtCQUErQjtBQUcvQjs7Ozs7Ozs7Ozs7OztHQWFHO0FBQ0gsTUFBYSwrQkFBZ0MsU0FBUSxHQUFHLENBQUMsd0JBQXdCO0lBU3hFLGVBQWUsQ0FDcEIsS0FBNkMsRUFDN0MsV0FBbUMsRUFDbkMsUUFBMkM7UUFFM0Msa0dBQWtHO1FBQ2xHLDhEQUE4RDtRQUU5RCxJQUFJLElBQUksQ0FBQyxpQkFBaUIsRUFBRTtZQUMxQixNQUFPLEdBQVcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUMzQixJQUFJLEtBQUssQ0FBQyx5Q0FBeUM7Z0JBQ3pDLHlCQUF5QixHQUFHLElBQUksQ0FBQyxPQUFPO2dCQUN4QyxRQUFRLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUNwQyxFQUFFLElBQUksRUFBRSx5Q0FBeUMsRUFBRSxDQUNwRCxDQUFDO1NBQ0g7UUFFRCxJQUFJLElBQUksR0FBRyxJQUFJLENBQUM7UUFDaEIsSUFBSSxPQUFPLEdBQUcsV0FBVyxDQUFDLFFBQVEsQ0FBQztRQUNuQyxJQUFJLGVBQWUsR0FBRyxXQUFXLENBQUMsaUJBQWlCLENBQUM7UUFDcEQsSUFBSSxVQUFVLEdBQUcsV0FBVyxDQUFDLFdBQVcsQ0FBQztRQUN6QyxJQUFJLFNBQVMsR0FBRyxXQUFXLENBQUMsVUFBVSxDQUFDO1FBQ3ZDLElBQUksYUFBYSxHQUFHLFdBQVcsQ0FBQyxjQUFjLENBQUM7UUFDL0MsSUFBSSxnQkFBZ0IsR0FBRyxXQUFXLENBQUMsaUJBQWlCLENBQUM7UUFFckQsSUFBSSxDQUFDLENBQUMsYUFBYSxLQUFLLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRTtZQUMxQyxNQUFPLEdBQVcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUMzQixJQUFJLEtBQUssQ0FBQyxzQ0FBc0MsSUFBSSxDQUFDLE9BQU8sb0ZBQW9G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QzdFLCtEQUErRDtRQUMvRCxJQUFJLDBCQUEwQixDQUFDLGNBQWMsRUFBRTtZQUM3QyxPQUFPLElBQUksR0FBRyxDQUFDLGNBQWMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxhQUFhLEVBQUUsQ0FBQyxDQUFDO1NBQzNEO1FBRUQsT0FBTyxJQUFJLCtCQUErQixDQUN2QyxHQUFXLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxJQUFJLEVBQUUsRUFBRTtZQUMxQyxPQUFPLEVBQUUsYUFBYTtZQUN0Qix1QkFBdUIsRUFBRSxJQUFJO1NBQzlCLENBQUMsQ0FDSCxDQUFDO0lBRUosQ0FBQztJQUVELDBHQUEwRztJQUMxRyx3REFBd0Q7SUFDaEQsMkJBQTJCLENBQUMsZ0JBQXdCO1FBQzFELCtGQUErRjtRQUMvRixRQUFRLGdCQUFnQixFQUFFO1lBQ3hCLEtBQUssYUFBYSxDQUFDLENBQUM7Z0JBQ2xCLE9BQU8sSUFBSSxHQUFHLENBQUMsc0JBQXNCLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDOUM7WUFDRCxLQUFLLHFCQUFxQixDQUFDLENBQUM7Z0JBQzFCLE9BQU8sSUFBSSxHQUFHLENBQUMsc0JBQXNCLEVBQUUsQ0FBQzthQUN6QztZQUNELEtBQUssY0FBYyxDQUFDLENBQUM7Z0JBQ25CLE9BQU8sSUFBSSxHQUFHLENBQUMsY0FBYyxFQUFFLENBQUM7YUFDakM7WUFDRCxPQUFPLENBQUMsQ0FBQztnQkFDUCxNQUFNLElBQUksS0FBSyxDQUFDLHFCQUFxQixnQkFBZ0IsZUFBZSxJQUFJLENBQUMsT0FBTyxpRkFBaUYsQ0FBQyxDQUFDO2FBQ3BLO1NBQ0Y7SUFFSCxDQUFDO0NBQ0Y7QUE5SkQsMEVBOEpDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgQVdTIGZyb20gJ2F3cy1zZGsnO1xuXG5cbi8qKlxuICogSGFjay1maXhcbiAqXG4gKiBUaGVyZSBhcmUgYSBudW1iZXIgb2YgaXNzdWVzIGluIHRoZSB1cHN0cmVhbSB2ZXJzaW9uIG9mIFNoYXJlZEluaUZpbGVDcmVkZW50aWFsc1xuICogdGhhdCBuZWVkIGZpeGluZzpcbiAqXG4gKiAxLiBUaGUgdXBzdHJlYW0gYXdzLXNkayBkb2VzIG5vdCBzdXBwb3J0IHRoZSAnY3JlZGVudGlhbF9zb3VyY2UnIG9wdGlvbi4gTWVhbmluZyBjcmVkZW50aWFsc1xuICogICAgZm9yIGFzc3VtZS1yb2xlIGNhbm5vdCBiZSBmZXRjaGVkIHVzaW5nIEVDMi9FU0MgbWV0YWRhdGEuXG4gKlxuICogMi4gVGhlIHVwc3RyZWFtIGF3cy1zZGsgZG9lcyBub3Qgc3VwcG9ydCBTU08gcHJvZmlsZXMgYXMgdGhlIHNvdXJjZSBvZiBSb2xlUHJvZmlsZXMsXG4gKiAgICBiZWNhdXNlIGl0IHdpbGwgYWx3YXlzIHVzZSB0aGUgYFNoYXJlZEluaUZpbGVDcmVkZW50aWFsc2AgcHJvdmlkZXIgdG8gbG9hZFxuICogICAgc291cmNlIGNyZWRlbnRpYWxzLCBidXQgaW4gb3JkZXIgdG8gc3VwcG9ydCBTU08gcHJvZmlsZXMgeW91IG11c3QgdXNlIGFcbiAqICAgIHNlcGFyYXRlIGNsYXNzIChgU3NvQ3JlZGVudGlhbHMpLlxuICovXG5leHBvcnQgY2xhc3MgUGF0Y2hlZFNoYXJlZEluaUZpbGVDcmVkZW50aWFscyBleHRlbmRzIEFXUy5TaGFyZWRJbmlGaWxlQ3JlZGVudGlhbHMge1xuICBkZWNsYXJlIHByaXZhdGUgcHJvZmlsZTogc3RyaW5nO1xuICBkZWNsYXJlIHByaXZhdGUgZmlsZW5hbWU6IHN0cmluZztcbiAgZGVjbGFyZSBwcml2YXRlIGRpc2FibGVBc3N1bWVSb2xlOiBib29sZWFuO1xuICBkZWNsYXJlIHByaXZhdGUgb3B0aW9uczogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcbiAgZGVjbGFyZSBwcml2YXRlIHJvbGVBcm46IHN0cmluZztcbiAgZGVjbGFyZSBwcml2YXRlIGh0dHBPcHRpb25zPzogQVdTLkhUVFBPcHRpb25zO1xuICBkZWNsYXJlIHByaXZhdGUgdG9rZW5Db2RlRm4/OiAobWZhU2VyaWFsOiBzdHJpbmcsIGNhbGxiYWNrOiAoZXJyPzogRXJyb3IsIHRva2VuPzogc3RyaW5nKSA9PiB2b2lkKSA9PiB2b2lkO1xuXG4gIHB1YmxpYyBsb2FkUm9sZVByb2ZpbGUoXG4gICAgY3JlZHM6IFJlY29yZDxzdHJpbmcsIFJlY29yZDxzdHJpbmcsIHN0cmluZz4+LFxuICAgIHJvbGVQcm9maWxlOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+LFxuICAgIGNhbGxiYWNrOiAoZXJyPzogRXJyb3IsIGRhdGE/OiBhbnkpID0+IHZvaWQpIHtcblxuICAgIC8vIE5lZWQgdG8gZHVwbGljYXRlIHRoZSB3aG9sZSBpbXBsZW1lbnRhdGlvbiBoZXJlIC0tIHRoZSBmdW5jdGlvbiBpcyBsb25nIGFuZCBoYXMgYmVlbiB3cml0dGVuIGluXG4gICAgLy8gc3VjaCBhIHdheSB0aGF0IHRoZXJlIGFyZSBubyBzbWFsbCBtb25rZXkgcGF0Y2hlcyBwb3NzaWJsZS5cblxuICAgIGlmICh0aGlzLmRpc2FibGVBc3N1bWVSb2xlKSB7XG4gICAgICB0aHJvdyAoQVdTIGFzIGFueSkudXRpbC5lcnJvcihcbiAgICAgICAgbmV3IEVycm9yKCdSb2xlIGFzc3VtcHRpb24gcHJvZmlsZXMgYXJlIGRpc2FibGVkLiAnICtcbiAgICAgICAgICAgICAgICAgICdGYWlsZWQgdG8gbG9hZCBwcm9maWxlICcgKyB0aGlzLnByb2ZpbGUgK1xuICAgICAgICAgICAgICAgICAgJyBmcm9tICcgKyBjcmVkcy5maWxlbmFtZSksXG4gICAgICAgIHsgY29kZTogJ1NoYXJlZEluaUZpbGVDcmVkZW50aWFsc1Byb3ZpZGVyRmFpbHVyZScgfSxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgIHZhciByb2xlQXJuID0gcm9sZVByb2ZpbGUucm9sZV9hcm47XG4gICAgdmFyIHJvbGVTZXNzaW9uTmFtZSA9IHJvbGVQcm9maWxlLnJvbGVfc2Vzc2lvbl9uYW1lO1xuICAgIHZhciBleHRlcm5hbElkID0gcm9sZVByb2ZpbGUuZXh0ZXJuYWxfaWQ7XG4gICAgdmFyIG1mYVNlcmlhbCA9IHJvbGVQcm9maWxlLm1mYV9zZXJpYWw7XG4gICAgdmFyIHNvdXJjZVByb2ZpbGUgPSByb2xlUHJvZmlsZS5zb3VyY2VfcHJvZmlsZTtcbiAgICB2YXIgY3JlZGVudGlhbFNvdXJjZSA9IHJvbGVQcm9maWxlLmNyZWRlbnRpYWxfc291cmNlO1xuXG4gICAgaWYgKCEhc291cmNlUHJvZmlsZSA9PT0gISFjcmVkZW50aWFsU291cmNlKSB7XG4gICAgICB0aHJvdyAoQVdTIGFzIGFueSkudXRpbC5lcnJvcihcbiAgICAgICAgbmV3IEVycm9yKGBXaGVuIHVzaW5nICdyb2xlX2FybicgaW4gcHJvZmlsZSAoJyR7dGhpcy5wcm9maWxlfScpLCB5b3UgbXVzdCBhbHNvIGNvbmZpZ3VyZSBleGFjdGx5IG9uZSBvZiAnc291cmNlX3Byb2ZpbGUnIG9yICdjcmVkZW50aWFsX3NvdXJjZSdgKSxcbiAgICAgICAgeyBjb2RlOiAnU2hhcmVkSW5pRmlsZUNyZWRlbnRpYWxzUHJvdmlkZXJGYWlsdXJlJyB9LFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBDb25maXJtZWQgdGhpcyBhZ2FpbnN0IEFXUyBDTEkgYmVoYXZpb3IgLS0gdGhlIHJlZ2lvbiBtdXN0IGJlIGluIHRoZSBhc3N1bUVEIHByb2ZpbGUsXG4gICAgLy8gb3RoZXJ3aXNlIGB1cy1lYXN0LTFgLiBGcm9tIHRoZSB1cHN0cmVhbSBjb21tZW50IGluIGBhd3Mtc2RrLWpzYDpcbiAgICAvLyAtLS0tLS0tLSBjb21tZW50IGZyb20gYXdzLXNkay1qcyAtLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy8gRXhwZXJpbWVudGF0aW9uIHNob3dzIHRoYXQgdGhlIEFXUyBDTEkgKHRlc3RlZCBhdCB2ZXJzaW9uIDEuMTguMTM2KVxuICAgIC8vIGlnbm9yZXMgdGhlIGZvbGxvd2luZyBwb3RlbnRpYWwgc291cmNlcyBvZiBhIHJlZ2lvbiBmb3IgdGhlIHB1cnBvc2VzIG9mXG4gICAgLy8gdGhpcyBBc3N1bWVSb2xlIGNhbGw6XG4gICAgLy9cbiAgICAvLyAtIFRoZSBbZGVmYXVsdF0gcHJvZmlsZVxuICAgIC8vIC0gVGhlIEFXU19SRUdJT04gZW52aXJvbm1lbnQgdmFyaWFibGVcbiAgICAvL1xuICAgIC8vIElnbm9yaW5nIHRoZSBbZGVmYXVsdF0gcHJvZmlsZSBmb3IgdGhlIHB1cnBvc2VzIG9mIEFzc3VtZVJvbGUgaXMgYXJndWFibHlcbiAgICAvLyBhIGJ1ZyBpbiB0aGUgQ0xJIHNpbmNlIGl0IGRvZXMgdXNlIHRoZSBbZGVmYXVsdF0gcmVnaW9uIGZvciBzZXJ2aWNlXG4gICAgLy8gY2FsbHMuLi4gYnV0IHJpZ2h0IG5vdyB3ZSdyZSBtYXRjaGluZyBiZWhhdmlvciBvZiB0aGUgb3RoZXIgdG9vbC5cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbiAgICBjb25zdCByZWdpb24gPSByb2xlUHJvZmlsZT8ucmVnaW9uID8/ICd1cy1lYXN0LTEnO1xuXG4gICAgY29uc3Qgc3RzQ3JlZHMgPSBzb3VyY2VQcm9maWxlID8gdGhpcy5zb3VyY2VQcm9maWxlQ3JlZGVudGlhbHMoc291cmNlUHJvZmlsZSwgY3JlZHMpIDogdGhpcy5jcmVkZW50aWFsU291cmNlQ3JlZGVudGlhbHMoY3JlZGVudGlhbFNvdXJjZSk7XG5cbiAgICB0aGlzLnJvbGVBcm4gPSByb2xlQXJuO1xuICAgIHZhciBzdHMgPSBuZXcgQVdTLlNUUyh7XG4gICAgICBjcmVkZW50aWFsczogc3RzQ3JlZHMsXG4gICAgICByZWdpb24sXG4gICAgICBodHRwT3B0aW9uczogdGhpcy5odHRwT3B0aW9ucyxcbiAgICB9KTtcblxuICAgIHZhciByb2xlUGFyYW1zOiBBV1MuU1RTLkFzc3VtZVJvbGVSZXF1ZXN0ID0ge1xuICAgICAgUm9sZUFybjogcm9sZUFybixcbiAgICAgIFJvbGVTZXNzaW9uTmFtZTogcm9sZVNlc3Npb25OYW1lIHx8ICdhd3Mtc2RrLWpzLScgKyBEYXRlLm5vdygpLFxuICAgIH07XG5cbiAgICBpZiAoZXh0ZXJuYWxJZCkge1xuICAgICAgcm9sZVBhcmFtcy5FeHRlcm5hbElkID0gZXh0ZXJuYWxJZDtcbiAgICB9XG5cbiAgICBpZiAobWZhU2VyaWFsICYmIHNlbGYudG9rZW5Db2RlRm4pIHtcbiAgICAgIHJvbGVQYXJhbXMuU2VyaWFsTnVtYmVyID0gbWZhU2VyaWFsO1xuICAgICAgc2VsZi50b2tlbkNvZGVGbihtZmFTZXJpYWwsIGZ1bmN0aW9uKGVyciwgdG9rZW4pIHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHZhciBtZXNzYWdlO1xuICAgICAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBFcnJvcikge1xuICAgICAgICAgICAgbWVzc2FnZSA9IGVyci5tZXNzYWdlO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBtZXNzYWdlID0gZXJyO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjYWxsYmFjayhcbiAgICAgICAgICAgIChBV1MgYXMgYW55KS51dGlsLmVycm9yKFxuICAgICAgICAgICAgICBuZXcgRXJyb3IoJ0Vycm9yIGZldGNoaW5nIE1GQSB0b2tlbjogJyArIG1lc3NhZ2UpLFxuICAgICAgICAgICAgICB7IGNvZGU6ICdTaGFyZWRJbmlGaWxlQ3JlZGVudGlhbHNQcm92aWRlckZhaWx1cmUnIH0sXG4gICAgICAgICAgICApKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICByb2xlUGFyYW1zLlRva2VuQ29kZSA9IHRva2VuO1xuICAgICAgICBzdHMuYXNzdW1lUm9sZShyb2xlUGFyYW1zLCBjYWxsYmFjayk7XG4gICAgICB9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgc3RzLmFzc3VtZVJvbGUocm9sZVBhcmFtcywgY2FsbGJhY2spO1xuICB9XG5cbiAgcHJpdmF0ZSBzb3VyY2VQcm9maWxlQ3JlZGVudGlhbHMoc291cmNlUHJvZmlsZTogc3RyaW5nLCBwcm9maWxlczogUmVjb3JkPHN0cmluZywgUmVjb3JkPHN0cmluZywgc3RyaW5nPj4pIHtcbiAgICB2YXIgc291cmNlUHJvZmlsZUV4aXN0YW5jZVRlc3QgPSBwcm9maWxlc1tzb3VyY2VQcm9maWxlXTtcblxuICAgIGlmICh0eXBlb2Ygc291cmNlUHJvZmlsZUV4aXN0YW5jZVRlc3QgIT09ICdvYmplY3QnKSB7XG4gICAgICB0aHJvdyAoQVdTIGFzIGFueSkudXRpbC5lcnJvcihcbiAgICAgICAgbmV3IEVycm9yKCdzb3VyY2VfcHJvZmlsZSAnICsgc291cmNlUHJvZmlsZSArICcgdXNpbmcgcHJvZmlsZSAnXG4gICAgICAgICAgKyB0aGlzLnByb2ZpbGUgKyAnIGRvZXMgbm90IGV4aXN0JyksXG4gICAgICAgIHsgY29kZTogJ1NoYXJlZEluaUZpbGVDcmVkZW50aWFsc1Byb3ZpZGVyRmFpbHVyZScgfSxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gV2UgbmVlZCB0byBkbyBhIG1hbnVhbCBjaGVjayBoZXJlIGlmIHRoZSBzb3VyY2UgcHJvZmlsZSAocHJvdmlkaW5nIHRoZVxuICAgIC8vIGNyZWRlbnRpYWxzIGZvciB0aGUgQXNzdW1lUm9sZSkgaXMgYW4gU1NPIHByb2ZpbGUuIFRoYXQncyBiZWNhdXNlXG4gICAgLy8gYFNoYXJlZEluaUZpbGVDcmVkZW50aWFsc2AgaXRzZWxmIGRvZXNuJ3Qgc3VwcG9ydCBwcm92aWRpbmcgY3JlZGVudGlhbHMgZnJvbVxuICAgIC8vIGFyYml0cmFyeSBwcm9maWxlcywgb25seSBmb3IgU3RhdGljQ3JlZGVudGlhbHMgYW5kIEFzc3VtZVJvbGUgdHlwZVxuICAgIC8vIHByb2ZpbGVzOyBpZiBpdCdzIGFuIFNTTyBwcm9maWxlIHlvdSBuZWVkIHRvIGluc3RhbnRpYXRlIGEgc3BlY2lhbFxuICAgIC8vIENyZWRlbnRpYWwgUHJvdmlkZXIgZm9yIHRoYXQuXG4gICAgLy9cbiAgICAvLyAtLS1cbiAgICAvL1xuICAgIC8vIEFuIFNTTyBwcm9maWxlIGNhbiBiZSBjb25maWd1cmVkIGluIDIgd2F5cyAocHV0IGFsbCB0aGUgaW5mbyBpbiB0aGUgcHJvZmlsZVxuICAgIC8vIHNlY3Rpb24sIG9yIHB1dCBoYWxmIG9mIGl0IGluIGFuIGBbc3NvLXNlc3Npb25dYCBibG9jayksIGJ1dCBpbiBib3RoIGNhc2VzXG4gICAgLy8gdGhlIHByaW1hcnkgcHJvZmlsZSBibG9jayBtdXN0IGhhdmUgdGhlIGBzc29fYWNjb3VudF9pZGAga2V5XG4gICAgaWYgKHNvdXJjZVByb2ZpbGVFeGlzdGFuY2VUZXN0LnNzb19hY2NvdW50X2lkKSB7XG4gICAgICByZXR1cm4gbmV3IEFXUy5Tc29DcmVkZW50aWFscyh7IHByb2ZpbGU6IHNvdXJjZVByb2ZpbGUgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBQYXRjaGVkU2hhcmVkSW5pRmlsZUNyZWRlbnRpYWxzKFxuICAgICAgKEFXUyBhcyBhbnkpLnV0aWwubWVyZ2UodGhpcy5vcHRpb25zIHx8IHt9LCB7XG4gICAgICAgIHByb2ZpbGU6IHNvdXJjZVByb2ZpbGUsXG4gICAgICAgIHByZWZlclN0YXRpY0NyZWRlbnRpYWxzOiB0cnVlLFxuICAgICAgfSksXG4gICAgKTtcblxuICB9XG5cbiAgLy8gdGhlIGF3cy1zZGsgZm9yIGpzIGRvZXMgbm90IHN1cHBvcnQgJ2NyZWRlbnRpYWxfc291cmNlJyAoaHR0cHM6Ly9naXRodWIuY29tL2F3cy9hd3Mtc2RrLWpzL2lzc3Vlcy8xOTE2KVxuICAvLyBzbyB1bmZvcnR1bmF0ZWx5IHdlIG5lZWQgdG8gaW1wbGVtZW50IHRoaXMgb3Vyc2VsdmVzLlxuICBwcml2YXRlIGNyZWRlbnRpYWxTb3VyY2VDcmVkZW50aWFscyhzb3VyY2VDcmVkZW50aWFsOiBzdHJpbmcpIHtcbiAgICAvLyBzZWUgaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2NyZWRyZWYvbGF0ZXN0L3JlZmRvY3Mvc2V0dGluZy1nbG9iYWwtY3JlZGVudGlhbF9zb3VyY2UuaHRtbFxuICAgIHN3aXRjaCAoc291cmNlQ3JlZGVudGlhbCkge1xuICAgICAgY2FzZSAnRW52aXJvbm1lbnQnOiB7XG4gICAgICAgIHJldHVybiBuZXcgQVdTLkVudmlyb25tZW50Q3JlZGVudGlhbHMoJ0FXUycpO1xuICAgICAgfVxuICAgICAgY2FzZSAnRWMySW5zdGFuY2VNZXRhZGF0YSc6IHtcbiAgICAgICAgcmV0dXJuIG5ldyBBV1MuRUMyTWV0YWRhdGFDcmVkZW50aWFscygpO1xuICAgICAgfVxuICAgICAgY2FzZSAnRWNzQ29udGFpbmVyJzoge1xuICAgICAgICByZXR1cm4gbmV3IEFXUy5FQ1NDcmVkZW50aWFscygpO1xuICAgICAgfVxuICAgICAgZGVmYXVsdDoge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGNyZWRlbnRpYWxfc291cmNlICR7c291cmNlQ3JlZGVudGlhbH0gaW4gcHJvZmlsZSAke3RoaXMucHJvZmlsZX0gaXMgdW5zdXBwb3J0ZWQuIGNob29zZSBvbmUgb2YgW0Vudmlyb25tZW50LCBFYzJJbnN0YW5jZU1ldGFkYXRhLCBFY3NDb250YWluZXJdYCk7XG4gICAgICB9XG4gICAgfVxuXG4gIH1cbn1cbiJdfQ==